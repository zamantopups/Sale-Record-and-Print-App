<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Sales & Expense Record</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom styles for printing */
        @media print {
            /* Hide the main form, header, and controls during print */
            #main-app, #header, #expense-section, #summary-section, #sales-list-section, #expenses-list-section, #app-controls, #history-form, #history-report-section {
                display: none !important;
            }
            /* Show only the receipt/report content */
            #receipt-print-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                margin: 0;
                padding: 15px; 
                background: white;
                
                /* Receipt/Report-specific styling */
                font-family: 'Arial', sans-serif; 
                color: #000; 
                font-size: 10pt; 
            }
            /* Reset body padding for print */
            body {
                padding: 0;
                margin: 0;
                background-color: white;
            }
            /* Ensure all text is legible and dark for light ink printers */
            #receipt-print-area * {
                font-weight: 500 !important; 
                color: #000 !important;
            }
            #receipt-print-area h2 {
                 font-size: 14pt !important;
                 font-weight: bold !important;
            }
            .credit-highlight-print {
                color: #0d9488 !important; /* Teal for credit */
                border: 1px dashed #0d9488 !important;
                padding: 2px !important;
                display: block !important;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Print Area (Initially Hidden) - Used for individual receipts or the monthly report -->
    <div id="receipt-print-area" class="hidden"></div>
    
    <!-- Main Application Container -->
    <div id="main-app" class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-4 sm:p-10">
        <header id="header" class="mb-8 border-b-2 pb-4">
            <h1 class="text-4xl font-extrabold text-center text-indigo-700">Shop Sales & Expense Management</h1>
            <p class="text-center text-sm text-gray-500 mt-2" id="user-info">Data saved locally in your browser.</p> 
        </header>

        <main id="app-content">

            <!-- 0. Summary Section (Current Month) -->
            <section id="summary-section" class="mb-10 p-6 bg-gray-100 rounded-xl shadow-inner">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Current Month Summary (Real-time)</h2>
                <div class="grid grid-cols-3 gap-6 text-center">
                    
                    <div class="bg-white p-5 rounded-lg shadow-md border-b-4 border-green-500">
                        <div class="text-sm font-medium text-gray-500">Total Sales</div>
                        <div id="total-sales" class="text-3xl font-extrabold text-green-700 mt-1">0.00 PKR</div>
                    </div>
                    
                    <div class="bg-white p-5 rounded-lg shadow-md border-b-4 border-red-500">
                        <div class="text-sm font-medium text-gray-500">Total Expenses</div>
                        <div id="total-expenses" class="text-3xl font-extrabold text-red-700 mt-1">0.00 PKR</div>
                    </div>
                    
                    <div class="bg-white p-5 rounded-lg shadow-md border-b-4 border-indigo-500">
                        <div class="text-sm font-medium text-gray-500">Net Profit</div>
                        <div id="net-profit" class="text-3xl font-extrabold text-indigo-700 mt-1">0.00 PKR</div>
                    </div>
                </div>
            </section>
            
            <!-- 0.5 History Report Generator (New/Restored Section) -->
            <section id="history-report-section" class="mb-10 p-6 bg-yellow-50 rounded-xl shadow-md border-l-4 border-yellow-500">
                <h2 class="text-2xl font-bold text-yellow-800 mb-4 border-b pb-2">History Report & Print</h2>
                
                <form id="history-form" class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                    <!-- Start Date -->
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" id="start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    
                    <!-- End Date -->
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" id="end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-yellow-500 focus:border-yellow-500">
                    </div>

                    <!-- Generate Button -->
                    <div class="col-span-1 sm:col-span-2 flex space-x-3">
                        <button type="submit" id="generate-report-btn" class="w-1/2 bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition duration-150 shadow-md flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 001.414 1.414L10 16.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm13 8H4V5h12v6z" clip-rule="evenodd" />
                            </svg>
                            Generate Report
                        </button>
                        <button type="button" id="print-report-btn" class="w-1/2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md flex items-center justify-center" disabled>
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 4v2a2 2 0 002 2h6a2 2 0 002-2V4h1a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2h1zm0 2h10v10a1 1 0 01-1 1H6a1 1 0 01-1-1V6z" clip-rule="evenodd" />
                                <path d="M10 12a1 1 0 100-2 1 1 0 000 2z" />
                            </svg>
                            Print Report
                        </button>
                    </div>
                </form>
                
                <div id="history-results" class="mt-6 p-4 border border-gray-300 rounded-lg bg-white hidden">
                    <h3 class="text-xl font-bold mb-3 text-yellow-800">Duration Summary</h3>
                    <div id="duration-summary-container" class="grid grid-cols-3 gap-4 text-center">
                        <!-- Summary details will be populated here -->
                    </div>
                    <h4 class="text-lg font-semibold mt-6 mb-2">Detailed Breakdown</h4>
                    <div id="duration-details" class="space-y-3">
                        <!-- Detailed sales/expense items will be populated here -->
                    </div>
                </div>
            </section>

            <!-- 1. New Sale Entry Form -->
            <section class="mb-10 p-6 bg-indigo-50 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-800 border-b pb-2">New Sale Entry</h2>
                
                <!-- New: Sale Type and Customer Name -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-white rounded-lg border border-indigo-200">
                    <!-- Sale Type (Cash/Credit) -->
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Transaction Type</label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="sale-type" value="Cash" id="sale-type-cash" checked class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                <span class="ml-2 text-gray-700 font-medium">Cash Sale</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="sale-type" value="Credit" id="sale-type-credit" class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                <span class="ml-2 text-gray-700 font-medium">Credit Sale</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Customer Name Input -->
                    <div class="col-span-1 md:col-span-2">
                        <label for="customer-name" id="customer-name-label" class="block text-sm font-medium text-gray-700">Customer Name</label>
                        <input type="text" id="customer-name" placeholder="Enter Customer Name (Optional)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- Item details grid (Existing) -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <!-- Service Type Selector (Column 1) -->
                    <div>
                        <label for="service-type" class="block text-sm font-medium text-gray-700">Service / Item Category</label>
                        <select id="service-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- Services -->
                            <optgroup label="Photocopy">
                                <option value="Photocopy B/W">B/W (Single Sided)</option>
                                <option value="Photocopy (Double Sided B/W)">B/W (Double Sided)</option>
                                <option value="Photocopy Color">Color (Single Sided)</option>
                                <option value="Photocopy (Double Sided Color)">Color (Double Sided)</option>
                            </optgroup>
                            <optgroup label="Printing">
                                <option value="Print (B/W)">B/W (Single Sided)</option>
                                <option value="Print (Double Sided B/W)">B/W (Double Sided)</option>
                                <option value="Print (Color)">Color (Single Sided)</option>
                                <option value="Print (Double Sided Color)">Color (Double Sided)</option>
                            </optgroup>
                            <optgroup label="Other Services">
                                <option value="Scanning">Scanning</option>
                                <option value="Binding">Binding</option>
                                <option value="Typing">Typing</option> 
                                <option value="Editing">Editing</option> 
                            </optgroup>
                            <!-- Single option for all other stationery/custom items -->
                            <option value="Custom Stationery/Item">Stationery / Other Item (Manual Entry)</option>
                        </select>
                    </div>

                    <!-- Quantity Input (Column 2) -->
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="quantity" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Price Input (Can be adjusted manually) (Column 3) -->
                    <div>
                        <label for="price-per-unit" class="block text-sm font-medium text-gray-700">Price (Per Unit) PKR</label>
                        <input type="number" id="price-per-unit" step="0.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Add Button (Column 4) -->
                    <div class="flex items-end">
                        <button id="add-item-btn" class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition duration-150 shadow-md">
                            Add Item
                        </button>
                    </div>
                </div>
                
                <!-- New Custom Description Input (Appears only when Stationery/Custom is selected) -->
                <div id="custom-item-name-container" class="mb-4" style="display: none;">
                    <label for="custom-item-name" class="block text-sm font-medium text-gray-700">Custom Item Name (Required)</label>
                    <input type="text" id="custom-item-name" placeholder="e.g., A4 White Paper, Stapler, etc." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                </div>


                <!-- Current Sale Items -->
                <div id="current-sale-items" class="mt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Current Bill</h3>
                    <ul id="cart-list" class="space-y-2">
                        <!-- Items will be appended here -->
                        <li id="empty-cart-message" class="text-sm text-gray-500">No items added to the bill.</li>
                    </ul>
                </div>

                <!-- Total and Save Button -->
                <div class="mt-6 pt-4 border-t border-indigo-200 flex justify-between items-center">
                    <div class="text-xl font-bold text-indigo-900">
                        Total Amount: <span id="total-amount">0.00</span> PKR
                    </div>
                    <button id="save-sale-btn" class="bg-indigo-600 text-white px-8 py-3 rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg disabled:opacity-50" disabled>
                        Save Sale
                    </button>
                </div>
            </section>

            <!-- 2. Expense Entry Form -->
            <section id="expense-section" class="mb-10 p-6 bg-red-50 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-red-800 border-b pb-2">New Expense Entry</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <!-- Expense Description -->
                    <div class="col-span-1 md:col-span-2">
                        <label for="expense-description" class="block text-sm font-medium text-gray-700">Description / Item</label>
                        <input type="text" id="expense-description" placeholder="e.g., Paper stock purchase" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500">
                    </div>

                    <!-- Expense Amount -->
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-gray-700">Amount (PKR)</label>
                        <input type="number" id="expense-amount" min="1" step="0.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500">
                    </div>

                    <!-- Save Expense Button -->
                    <div class="flex items-end">
                        <button id="save-expense-btn" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                            Save Expense
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- 3. Recent Sales Record -->
            <section id="sales-list-section" class="p-6 bg-white rounded-xl shadow-md mb-10">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-800 border-b pb-2">Recent Sales History (Individual)</h2>
                <div id="sales-list" class="space-y-4">
                    <!-- Sales records will be displayed here -->
                    <p id="no-sales-message" class="text-gray-500">No sales record found.</p>
                </div>
            </section>
            
            <!-- 4. Recent Expenses Record -->
            <section id="expenses-list-section" class="p-6 bg-white rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4 text-red-800 border-b pb-2">Recent Expenses History</h2>
                <div id="expenses-list" class="space-y-4">
                    <!-- Expense records will be displayed here -->
                    <p id="no-expenses-message" class="text-gray-500">No expense record found.</p>
                </div>
            </section>

            <!-- Custom Message Box for errors/success -->
            <div id="message-box" class="fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-xl transition-opacity duration-300 hidden" style="opacity: 0;">
                <!-- Message content here -->
            </div>

        </main>
    </div>

    <!-- Local Storage Script -->
    <script type="module">
        
        // --- DOM Elements ---
        // Sales elements
        const serviceTypeSelect = document.getElementById('service-type');
        const quantityInput = document.getElementById('quantity');
        const pricePerUnitInput = document.getElementById('price-per-unit');
        const addItemBtn = document.getElementById('add-item-btn');
        const cartList = document.getElementById('cart-list');
        const totalAmountSpan = document.getElementById('total-amount');
        const saveSaleBtn = document.getElementById('save-sale-btn');
        const salesListContainer = document.getElementById('sales-list');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const noSalesMessage = document.getElementById('no-sales-message');
        const receiptPrintArea = document.getElementById('receipt-print-area');
        const messageBox = document.getElementById('message-box');
        const customItemNameContainer = document.getElementById('custom-item-name-container');
        const customItemNameInput = document.getElementById('custom-item-name');

        // New Credit/Customer Elements
        const saleTypeRadios = document.querySelectorAll('input[name="sale-type"]');
        const customerNameInput = document.getElementById('customer-name');
        const customerNameLabel = document.getElementById('customer-name-label');


        // Expense elements
        const expenseDescriptionInput = document.getElementById('expense-description');
        const expenseAmountInput = document.getElementById('expense-amount');
        const saveExpenseBtn = document.getElementById('save-expense-btn');
        const expensesListContainer = document.getElementById('expenses-list');
        const noExpensesMessage = document.getElementById('no-expenses-message');
        
        // Summary elements
        const totalSalesSpan = document.getElementById('total-sales');
        const totalExpensesSpan = document.getElementById('total-expenses');
        const netProfitSpan = document.getElementById('net-profit');
        
        // History elements
        const historyForm = document.getElementById('history-form');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const printReportBtn = document.getElementById('print-report-btn');
        const historyResultsContainer = document.getElementById('history-results');
        const durationSummaryContainer = document.getElementById('duration-summary-container');
        const durationDetailsContainer = document.getElementById('duration-details');

        // --- CONSTANTS AND STATE ---
        let currentCart = []; // {type, quantity, unitPrice, subTotal}
        const LOCAL_STORAGE_SALE_KEY = 'shop_sales_data'; // Key for sales data
        const LOCAL_STORAGE_EXPENSE_KEY = 'shop_expenses_data'; // Key for expense data
        
        let latestReportData = null; // Store the last generated report data for printing

        // Company details for receipt
        const COMPANY_NAME = "Zaman Printing Services";
        const COMPANY_ADDRESS = "Basement No. 6, Al-Anayat Shopping Mall, G-11 Markaz, Islamabad";


        // Service rates 
        const PRICE_LIST = {
            // Photocopy
            'Photocopy B/W': 7.0, 
            'Photocopy (Double Sided B/W)': 14.0, 
            'Photocopy Color': 40.0,
            'Photocopy (Double Sided Color)': 80.0, 
            
            // Printing
            'Print (B/W)': 10.0, 
            'Print (Double Sided B/W)': 20.0, 
            'Print (Color)': 40.0, 
            'Print (Double Sided Color)': 80.0, 
            
            // Other Services 
            'Scanning': 20.0,
            'Binding': 70.0,
            'Typing': 300.0, 
            'Editing': 100.0, 
        };

        // --- UTILITY FUNCTIONS ---

        /** Shows a temporary message notification */
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = 'fixed top-4 right-4 text-white p-4 rounded-lg shadow-xl transition-opacity duration-300';
            messageBox.style.opacity = 1;
            messageBox.classList.add(isError ? 'bg-red-500' : 'bg-green-600');
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.style.opacity = 0;
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        /** Formats a timestamp into a readable date/time string. */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const options = {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit',
                hour12: true
            };
            return date.toLocaleString('en-US', options);
        }
        
        /** Checks if a date falls within the current month (for summary) */
        function isCurrentMonth(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            return date.getFullYear() === now.getFullYear() && date.getMonth() === now.getMonth();
        }
        
        // --- LOCAL STORAGE FUNCTIONS: SALES & EXPENSES ---
        
        function loadSalesFromLocalStorage() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_SALE_KEY);
                const sales = data ? JSON.parse(data) : [];
                sales.forEach(sale => {
                    // Ensure items is an array, handling old stringified formats if any
                    if (typeof sale.items === 'string') {
                        try { sale.items = JSON.parse(sale.items); } catch (e) { sale.items = []; }
                    }
                    // Handle older sales data that might not have saleType/customerName
                    if (!sale.saleType) {
                        sale.saleType = 'Cash';
                        sale.customerName = '';
                    }
                });
                sales.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                return sales;
            } catch (error) {
                console.error("Error loading sales data from local storage:", error);
                return [];
            }
        }

        function saveSalesToLocalStorage(sales) {
            try {
                localStorage.setItem(LOCAL_STORAGE_SALE_KEY, JSON.stringify(sales));
                renderSalesList(sales);
                updateAllSummaries();
            } catch (error) {
                console.error("Error saving sales data to local storage:", error);
                showMessage('Error saving sale data locally.', true);
            }
        }
        
        function deleteSale(saleId) {
            const saleIdInt = parseInt(saleId, 10);
            const existingSales = loadSalesFromLocalStorage();
            const updatedSales = existingSales.filter(sale => sale.id !== saleIdInt);
            saveSalesToLocalStorage(updatedSales);
            showMessage('Sale record deleted successfully. (Permanent Action)', false);
        }

        function loadExpensesFromLocalStorage() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_EXPENSE_KEY);
                const expenses = data ? JSON.parse(data) : [];
                expenses.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                return expenses;
            } catch (error) {
                console.error("Error loading expenses data from local storage:", error);
                return [];
            }
        }

        function saveExpensesToLocalStorage(expenses) {
            try {
                localStorage.setItem(LOCAL_STORAGE_EXPENSE_KEY, JSON.stringify(expenses));
                renderExpenseList(expenses);
                updateAllSummaries();
            } catch (error) {
                console.error("Error saving expenses data to local storage:", error);
                showMessage('Error saving expense data locally.', true);
            }
        }
        
        function deleteExpense(expenseId) {
            const expenseIdInt = parseInt(expenseId, 10);
            const existingExpenses = loadExpensesFromLocalStorage();
            const updatedExpenses = existingExpenses.filter(expense => expense.id !== expenseIdInt);

            saveExpensesToLocalStorage(updatedExpenses);
            showMessage('Expense record deleted successfully. (Permanent Action)', false);
        }
        
        // --- SUMMARY & HISTORY FUNCTIONS ---
        
        /** Filters data based on a date range (inclusive). */
        function getFilteredData(startDateStr, endDateStr) {
            const allSales = loadSalesFromLocalStorage();
            const allExpenses = loadExpensesFromLocalStorage();

            // Set time to start of day for start date and end of day for end date
            const start = startDateStr ? new Date(startDateStr) : new Date(0);
            const end = endDateStr ? new Date(endDateStr) : new Date();
            // Move end date to the end of the day for inclusivity
            if (endDateStr) end.setDate(end.getDate() + 1);

            const filteredSales = allSales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate >= start && saleDate < end;
            });

            const filteredExpenses = allExpenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= start && expenseDate < end;
            });
            
            // Calculate totals
            const totalSales = filteredSales.reduce((sum, sale) => sum + sale.totalAmount, 0);
            const totalExpenses = filteredExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = totalSales - totalExpenses;

            return {
                sales: filteredSales,
                expenses: filteredExpenses,
                summary: { totalSales, totalExpenses, netProfit }
            };
        }
        
        /** Updates the Current Month Summary (top section). */
        function updateCurrentMonthSummary() {
            const allSales = loadSalesFromLocalStorage();
            const allExpenses = loadExpensesFromLocalStorage();
            
            const currentMonthSales = allSales.filter(sale => isCurrentMonth(sale.date));
            const currentMonthExpenses = allExpenses.filter(expense => isCurrentMonth(expense.date));
            
            const totalSales = currentMonthSales.reduce((sum, sale) => sum + sale.totalAmount, 0);
            const totalExpenses = currentMonthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = totalSales - totalExpenses;
            
            totalSalesSpan.textContent = totalSales.toFixed(2) + ' PKR';
            totalExpensesSpan.textContent = totalExpenses.toFixed(2) + ' PKR';
            netProfitSpan.textContent = netProfit.toFixed(2) + ' PKR';
            
            netProfitSpan.classList.toggle('text-red-700', netProfit < 0);
            netProfitSpan.classList.toggle('text-indigo-700', netProfit >= 0);
        }
        
        /** Calls all update functions */
        function updateAllSummaries() {
            // Update Current Month Summary
            updateCurrentMonthSummary();
        }
        
        /** Renders the results of the filtered history report */
        function renderHistoryReport(data) {
            latestReportData = data;
            historyResultsContainer.classList.remove('hidden');
            printReportBtn.disabled = false;

            const summary = data.summary;
            
            // 1. Render Summary Block
            durationSummaryContainer.innerHTML = `
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm border-b-2 border-green-500">
                    <div class="text-sm font-medium text-gray-500">Total Sales</div>
                    <div class="text-xl font-extrabold text-green-700 mt-1">${summary.totalSales.toFixed(2)} PKR</div>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm border-b-2 border-red-500">
                    <div class="text-sm font-medium text-gray-500">Total Expenses</div>
                    <div class="text-xl font-extrabold text-red-700 mt-1">${summary.totalExpenses.toFixed(2)} PKR</div>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm border-b-2 ${summary.netProfit >= 0 ? 'border-indigo-500' : 'border-red-500'}">
                    <div class="text-sm font-medium text-gray-500">Net Profit</div>
                    <div class="text-xl font-extrabold ${summary.netProfit >= 0 ? 'text-indigo-700' : 'text-red-700'} mt-1">${summary.netProfit.toFixed(2)} PKR</div>
                </div>
            `;
            
            // 2. Render Detailed Breakdown
            durationDetailsContainer.innerHTML = '';
            
            // Combine and sort by date
            const combinedData = [
                ...data.sales.map(s => ({ ...s, type: 'Sale', amount: s.totalAmount, description: `Sale ID ${s.id}` })),
                ...data.expenses.map(e => ({ ...e, type: 'Expense', amount: e.amount, description: e.description }))
            ].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
            
            if (combinedData.length === 0) {
                durationDetailsContainer.innerHTML = '<p class="text-gray-500 p-2">No records found for this period.</p>';
                return;
            }

            combinedData.forEach(item => {
                const isSale = item.type === 'Sale';
                const itemDiv = document.createElement('div');
                itemDiv.className = `p-3 rounded-lg shadow-sm flex justify-between items-center ${isSale ? 'bg-green-50' : 'bg-red-50'}`;
                
                itemDiv.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-bold ${isSale ? 'text-green-800' : 'text-red-800'}">${item.type}</span>
                        <p class="text-sm text-gray-700">${isSale ? (Array.isArray(item.items) ? item.items.map(i => i.type).join(', ') : 'Details available on receipt') : item.description}</p>
                        <span class="text-xs text-gray-500">${formatTimestamp(item.date)}</span>
                    </div>
                    <div class="text-lg font-extrabold ${isSale ? 'text-green-700' : 'text-red-700'}">
                        ${isSale ? '+' : '-'} ${item.amount.toFixed(2)} PKR
                    </div>
                `;
                durationDetailsContainer.appendChild(itemDiv);
            });
        }
        
        // --- PRINTING FUNCTIONS ---

        /** Generates and triggers the print functionality for a single saved sale (RECEIPT) */
        function printReceipt(sale) {
            const dateStr = formatTimestamp(sale.date);
            
            let itemsHtml = (Array.isArray(sale.items) ? sale.items : []).map(item => `
                <tr>
                    <td class="py-0 px-1">${item.type}</td>
                    <td class="py-0 px-1 text-center">${item.quantity}</td>
                    <td class="py-0 px-1 text-right">${item.unitPrice.toFixed(2)}</td>
                    <td class="py-0 px-1 text-right">${item.subTotal.toFixed(2)}</td>
                </tr>
            `).join('');
            
            const saleType = sale.saleType || 'Cash';
            const customerName = sale.customerName || 'N/A';
            
            // Add a highlight for Credit sales
            const creditHighlight = saleType === 'Credit' ? 
                `<div class="text-center mt-3 p-1 font-bold text-teal-700 border-2 border-dashed border-teal-500 rounded-sm text-xs credit-highlight-print">
                    CREDIT SALE - Customer: ${customerName}
                </div>` : '';


            const receiptHtml = `
                <div class="max-w-xs mx-auto p-2">
                    <div class="text-center mb-2">
                        <h2 class="font-extrabold text-sm mb-0">${COMPANY_NAME}</h2> 
                        <p class="text-xs italic">${COMPANY_ADDRESS}</p> 
                    </div>
                    
                    <div style="border-top: 1px dashed black; margin-top: 4px; margin-bottom: 4px;"></div>

                    <p class="mb-1 text-xs">Date: ${dateStr}</p>
                    <p class="mb-1 text-xs">Trans. ID: ${sale.id}</p>
                    <p class="mb-3 text-xs">Type: <span class="font-bold">${saleType}</span></p>
                    
                    <div style="border-top: 1px dashed black; margin-bottom: 2px;"></div>

                    <table class="w-full border-collapse mb-2 text-xs">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-1 px-1 text-left" style="width: 40%;">Item</th>
                                <th class="py-1 px-1 text-center" style="width: 15%;">Qty</th>
                                <th class="py-1 px-1 text-right" style="width: 20%;">Rate</th>
                                <th class="py-1 px-1 text-right" style="width: 25%;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>

                    <div style="border-top: 1px dashed black; margin-top: 2px;"></div>
                    
                    <div class="flex justify-between font-bold text-sm pt-1">
                        <span>TOTAL</span>
                        <span>${sale.totalAmount.toFixed(2)} PKR</span>
                    </div>
                    
                    ${creditHighlight}
                    
                    <div style="border-top: 1px dashed black; margin-top: 8px; margin-bottom: 8px;"></div>
                    
                    <p class="text-center text-xs">Thank you for your business!</p>
                </div>
            `;
            
            receiptPrintArea.innerHTML = receiptHtml;
            window.print();
        }
        
        /** Generates and triggers the print functionality for the history report */
        function printHistoryReport(data) {
            // Implementation for history report printing remains largely the same 
            // as the sale type/customer name is primarily relevant for individual receipts and the sales list view.
            if (!data || data.sales.length === 0 && data.expenses.length === 0) {
                showMessage("No data to print for the selected period.", true);
                return;
            }
            
            const { summary, sales, expenses } = data;
            const startDate = startDateInput.value || 'Beginning';
            const endDate = endDateInput.value || 'Today';

            // Detailed Transactions (Sales + Expenses)
            const combinedData = [
                ...sales.map(s => ({ ...s, type: 'Sale', amount: s.totalAmount, description: s.customerName ? `Sale ID ${s.id} (${s.saleType} - ${s.customerName})` : `Sale ID ${s.id} (Cash)` })),
                ...expenses.map(e => ({ ...e, type: 'Expense', amount: e.amount, description: e.description }))
            ].sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime()); // Sort by date ascending for report

            let transactionsHtml = combinedData.map(item => `
                <tr class="${item.type === 'Sale' ? 'text-green-800' : 'text-red-800'} border-b border-gray-100">
                    <td class="py-1 px-2">${formatTimestamp(item.date)}</td>
                    <td class="py-1 px-2">${item.type}</td>
                    <td class="py-1 px-2 text-left">${item.type === 'Sale' ? (Array.isArray(item.items) ? item.items.map(i => i.type).join(', ') : item.description) : item.description}</td>
                    <td class="py-1 px-2 text-right font-medium">${item.type === 'Sale' ? '+' : '-'} ${item.amount.toFixed(2)}</td>
                </tr>
            `).join('');

            const reportHtml = `
                <div class="max-w-3xl mx-auto p-4">
                    <div class="text-center mb-6">
                        <h2 class="text-lg font-extrabold mb-0">${COMPANY_NAME}</h2>
                        <p class="text-sm">${COMPANY_ADDRESS}</p>
                        <h3 class="text-xl font-bold mt-4">FINANCIAL HISTORY REPORT</h3>
                        <p class="text-md text-gray-700 mt-1">
                            From: <span class="font-semibold">${startDate}</span> To: <span class="font-semibold">${endDate}</span>
                        </p>
                    </div>

                    <!-- Summary Table -->
                    <table class="w-full mb-6 border-2 border-gray-500">
                        <tr class="bg-gray-200">
                            <td class="p-2 font-bold w-1/3 text-green-700">TOTAL SALES</td>
                            <td class="p-2 font-bold w-1/3 text-red-700">TOTAL EXPENSES</td>
                            <td class="p-2 font-bold w-1/3 ${summary.netProfit >= 0 ? 'text-indigo-700' : 'text-red-700'}">NET PROFIT</td>
                        </tr>
                        <tr class="text-center bg-white font-extrabold text-lg">
                            <td class="p-2 text-green-700">${summary.totalSales.toFixed(2)} PKR</td>
                            <td class="p-2 text-red-700">${summary.totalExpenses.toFixed(2)} PKR</td>
                            <td class="p-2 ${summary.netProfit >= 0 ? 'text-indigo-700' : 'text-red-700'}">${summary.netProfit.toFixed(2)} PKR</td>
                        </tr>
                    </table>
                    
                    <!-- Transactions Details -->
                    <h4 class="text-lg font-bold mt-6 mb-3 border-b pb-1">All Transactions (${combinedData.length})</h4>
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-gray-100 font-bold border-b border-gray-400">
                                <th class="py-2 px-2 text-left w-[25%]">Date/Time</th>
                                <th class="py-2 px-2 text-left w-[15%]">Type</th>
                                <th class="py-2 px-2 text-left w-[40%]">Description</th>
                                <th class="py-2 px-2 text-right w-[20%]">Amount (PKR)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transactionsHtml}
                        </tbody>
                    </table>
                    
                    <div class="text-center mt-8 text-xs italic">
                        Report generated on ${formatTimestamp(new Date().toISOString())}
                    </div>
                </div>
            `;
            
            receiptPrintArea.innerHTML = reportHtml;
            window.print();
        }
        
        // --- GENERAL APP FLOW FUNCTIONS ---

        /** Resets the sale form and cart */
        function resetSale() {
            currentCart = [];
            renderCart();
            quantityInput.value = 1;
            serviceTypeSelect.value = 'Photocopy B/W'; 
            updatePricePerUnit();
            customItemNameInput.value = ''; // Reset custom item name
            customerNameInput.value = ''; // Reset customer name
            document.getElementById('sale-type-cash').checked = true; // Reset to Cash
            updateCustomerNameField(); // Reset label/placeholder
        }
        
        /** Resets the expense form */
        function resetExpenseForm() {
            expenseDescriptionInput.value = '';
            expenseAmountInput.value = '';
        }
        
        /** Initial load and display of the app */
        function initializeApp() {
            // Set initial date range to today for easy use
            const today = new Date().toISOString().split('T')[0];
            endDateInput.value = today;
            
            // Load and render sales and expenses
            const sales = loadSalesFromLocalStorage();
            renderSalesList(sales);
            
            const expenses = loadExpensesFromLocalStorage();
            renderExpenseList(expenses);

            updatePricePerUnit();
            updateAllSummaries(); // Initial population of all summary views
            updateCustomerNameField(); // Initial check for customer name field label
        }

        // --- EVENT HANDLERS: SALE ---
        
        /** Updates the visibility and label for the customer name field based on sale type */
        function updateCustomerNameField() {
            const selectedType = document.querySelector('input[name="sale-type"]:checked').value;
            if (selectedType === 'Credit') {
                customerNameLabel.innerHTML = 'Customer Name <span class="text-red-600 font-bold">(Required)</span>';
                customerNameInput.placeholder = 'Enter Customer Name';
            } else {
                customerNameLabel.textContent = 'Customer Name';
                customerNameInput.placeholder = 'Enter Customer Name (Optional)';
            }
        }
        
        saleTypeRadios.forEach(radio => {
            radio.addEventListener('change', updateCustomerNameField);
        });


        /** Updates the Price Per Unit input with the default rate for the selected service, and toggles custom input visibility. */
        function updatePricePerUnit() {
            const selectedType = serviceTypeSelect.value;
            
            if (selectedType === 'Custom Stationery/Item') {
                customItemNameContainer.style.display = 'block';
                pricePerUnitInput.value = '0.00'; 
            } else {
                customItemNameContainer.style.display = 'none';
                const price = PRICE_LIST[selectedType] || 0;
                pricePerUnitInput.value = price.toFixed(2);
            }
        }
        
        serviceTypeSelect.addEventListener('change', updatePricePerUnit);

        addItemBtn.addEventListener('click', () => {
            let type = serviceTypeSelect.value;
            const quantity = parseInt(quantityInput.value, 10);
            const unitPrice = parseFloat(pricePerUnitInput.value); 

            if (quantity < 1 || isNaN(quantity) || unitPrice <= 0 || isNaN(unitPrice)) {
                showMessage('Please enter valid quantity and price.', true);
                return;
            }
            
            if (type === 'Custom Stationery/Item') {
                const customName = customItemNameInput.value.trim();
                if (!customName) {
                    showMessage('Please enter the name of the custom item (Required).', true);
                    return;
                }
                type = customName; 
            }

            const subTotal = quantity * unitPrice;
            
            currentCart.push({ type, quantity, unitPrice, subTotal });
            
            renderCart();
            quantityInput.value = 1; 
            customItemNameInput.value = ''; 
            showMessage(`${type} added to the bill.`);
            
            if (serviceTypeSelect.value === 'Custom Stationery/Item') {
                serviceTypeSelect.value = 'Photocopy B/W'; 
                updatePricePerUnit();
            }
        });

        saveSaleBtn.addEventListener('click', () => {
            if (currentCart.length === 0) {
                showMessage('Please add items to the bill first.', true);
                return;
            }
            
            const saleType = document.querySelector('input[name="sale-type"]:checked').value;
            const customerName = customerNameInput.value.trim();

            if (saleType === 'Credit' && !customerName) {
                showMessage('Customer Name is required for Credit Sales.', true);
                return;
            }

            saveSaleBtn.disabled = true;
            saveSaleBtn.textContent = 'Saving...';
            
            const totalAmount = currentCart.reduce((sum, item) => sum + item.subTotal, 0);
            
            const newSale = {
                id: Date.now(), 
                date: new Date().toISOString(), 
                items: currentCart, 
                totalAmount: totalAmount,
                saleType: saleType, // New field
                customerName: customerName, // New field
            };

            const existingSales = loadSalesFromLocalStorage();
            existingSales.push(newSale);
            saveSalesToLocalStorage(existingSales);

            showMessage(`Sale saved successfully! (${saleType})`, false);
            resetSale();
            
            saveSaleBtn.disabled = false;
            saveSaleBtn.textContent = 'Save Sale';
        });
        
        // --- EVENT HANDLERS: EXPENSE ---
        
        saveExpenseBtn.addEventListener('click', () => {
            const description = expenseDescriptionInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);

            if (!description) {
                showMessage('Please enter a description for the expense.', true);
                return;
            }
            if (amount <= 0 || isNaN(amount)) {
                showMessage('Please enter a valid expense amount.', true);
                return;
            }

            saveExpenseBtn.disabled = true;
            saveExpenseBtn.textContent = 'Saving...';

            const newExpense = {
                id: Date.now(),
                date: new Date().toISOString(),
                description: description,
                amount: amount,
            };

            const existingExpenses = loadExpensesFromLocalStorage();
            existingExpenses.push(newExpense);
            saveExpensesToLocalStorage(existingExpenses);
            
            showMessage('Expense saved successfully!', false);
            resetExpenseForm();
            
            saveExpenseBtn.disabled = false;
            saveExpenseBtn.textContent = 'Save Expense';
        });
        
        // --- EVENT HANDLERS: HISTORY ---
        
        historyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            generateReportBtn.textContent = 'Generating...';
            generateReportBtn.disabled = true;
            printReportBtn.disabled = true;
            historyResultsContainer.classList.add('hidden');
            
            const startDateStr = startDateInput.value;
            const endDateStr = endDateInput.value;
            
            if (!startDateStr && !endDateStr) {
                showMessage('Please select at least a start or end date.', true);
                generateReportBtn.textContent = 'Generate Report';
                generateReportBtn.disabled = false;
                return;
            }
            
            // Check if start date is after end date
            if (startDateStr && endDateStr && new Date(startDateStr) > new Date(endDateStr)) {
                showMessage('Start Date cannot be after End Date.', true);
                generateReportBtn.textContent = 'Generate Report';
                generateReportBtn.disabled = false;
                return;
            }

            const data = getFilteredData(startDateStr, endDateStr);
            renderHistoryReport(data);
            
            generateReportBtn.textContent = 'Report Generated!';
            generateReportBtn.disabled = false;
        });
        
        printReportBtn.addEventListener('click', () => {
            if (latestReportData) {
                printHistoryReport(latestReportData);
            } else {
                showMessage('Please generate a report first.', true);
            }
        });

        // --- RENDERING FUNCTIONS: CART & LISTS (Updated) ---
        
        /** Calculates and updates the cart's total amount */
        function updateCartTotal() {
            const total = currentCart.reduce((sum, item) => sum + item.subTotal, 0);
            totalAmountSpan.textContent = total.toFixed(2);
            saveSaleBtn.disabled = currentCart.length === 0;
            emptyCartMessage.style.display = currentCart.length === 0 ? 'block' : 'none';
        }

        /** Renders the current items in the cart UI */
        function renderCart() {
            cartList.innerHTML = '';
            currentCart.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg';
                li.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-medium">${item.type}</span> 
                        <span class="text-sm text-gray-500">(${item.quantity} x ${item.unitPrice.toFixed(2)} PKR)</span>
                    </div>
                    <div class="font-bold text-indigo-600">${item.subTotal.toFixed(2)} PKR</div>
                    <button data-index="${index}" class="remove-item-btn ml-4 text-red-500 hover:text-red-700 transition duration-150" title="Remove Item">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                cartList.appendChild(li);
            });
            updateCartTotal();
            
            document.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index, 10);
                    currentCart.splice(index, 1);
                    renderCart();
                    showMessage('Item removed.');
                });
            });
        }
        
        /** Renders the list of all saved sales */
        function renderSalesList(sales) {
            salesListContainer.innerHTML = '';
            
            if (sales.length === 0) {
                noSalesMessage.style.display = 'block';
                return;
            }
            noSalesMessage.style.display = 'none';

            sales.slice(0, 10).forEach(sale => { // Show only recent 10
                const saleCard = document.createElement('div');
                
                const saleType = sale.saleType || 'Cash';
                const customerName = sale.customerName || 'N/A';
                
                // Highlight for Credit Sales
                const isCredit = saleType === 'Credit';
                const typeClass = isCredit ? 'border-teal-400 bg-teal-50' : 'border-gray-200 bg-white';
                const typeTextClass = isCredit ? 'text-teal-700' : 'text-indigo-700';
                
                saleCard.className = `p-4 border-l-4 rounded-lg shadow-sm hover:shadow-md transition duration-150 ${typeClass}`;
                
                const dateStr = formatTimestamp(sale.date);
                
                const itemsArray = Array.isArray(sale.items) ? sale.items : [];
                const itemsSummary = itemsArray.map(item => `${item.type} (${item.quantity})`).join(', ');
                
                const customerDetail = isCredit ? `<p class="text-sm font-semibold text-teal-800">Customer: ${customerName}</p>` : `<p class="text-xs text-gray-500">Cash Sale</p>`;

                saleCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="text-xl font-bold ${typeTextClass}">${sale.totalAmount.toFixed(2)} PKR</div>
                            ${customerDetail}
                        </div>
                        <span class="text-sm text-gray-500 text-right">${dateStr}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3 truncate border-t border-gray-100 pt-2" title="${itemsSummary}">Items: ${itemsSummary}</p>
                    
                    <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                        <!-- Print Button -->
                        <button data-sale-id="${sale.id}" class="print-btn text-blue-600 hover:text-blue-800 font-medium transition duration-150 flex items-center text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 4v2a2 2 0 002 2h6a2 2 0 002-2V4h1a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2h1zm0 2h10v10a1 1 0 01-1 1H6a1 1 0 01-1-1V6z" clip-rule="evenodd" />
                                <path d="M10 12a1 1 0 100-2 1 1 0 000 2z" />
                            </svg>
                            Print Receipt
                        </button>
                        
                        <!-- Delete Button -->
                        <button data-sale-id="${sale.id}" class="delete-sale-btn text-red-500 hover:text-red-700 font-medium transition duration-150 flex items-center text-sm">
                            <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete
                        </button>
                    </div>
                `;
                salesListContainer.appendChild(saleCard);
            });
            
            // Add click listeners to print buttons
            document.querySelectorAll('.print-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const saleId = e.currentTarget.dataset.saleId;
                    const sales = loadSalesFromLocalStorage();
                    const saleToPrint = sales.find(s => String(s.id) === saleId);
                    
                    if (saleToPrint) {
                        printReceipt(saleToPrint);
                    } else {
                        showMessage('Sale record not found.', true);
                    }
                });
            });
            
            // Add click listeners to DELETE buttons
            document.querySelectorAll('.delete-sale-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const saleId = e.currentTarget.dataset.saleId;
                    deleteSale(saleId);
                });
            });
        }
        
        /** Renders the list of all saved expenses */
        function renderExpenseList(expenses) {
            expensesListContainer.innerHTML = '';
            
            if (expenses.length === 0) {
                noExpensesMessage.style.display = 'block';
                return;
            }
            noExpensesMessage.style.display = 'none';

            expenses.slice(0, 10).forEach(expense => { // Show only recent 10
                const expenseCard = document.createElement('div');
                expenseCard.className = 'p-4 border border-gray-200 rounded-lg shadow-sm bg-white hover:shadow-md transition duration-150 flex justify-between items-center';
                
                const dateStr = formatTimestamp(expense.date);

                expenseCard.innerHTML = `
                    <div class="flex-grow">
                        <div class="text-md font-medium text-gray-800">${expense.description}</div>
                        <span class="text-sm text-gray-500">${dateStr}</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="text-xl font-bold text-red-700">${expense.amount.toFixed(2)} PKR</div>
                        
                        <!-- Delete Button -->
                        <button data-expense-id="${expense.id}" class="delete-expense-btn text-gray-400 hover:text-red-600 transition duration-150 p-1 rounded" title="Delete Expense">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                expensesListContainer.appendChild(expenseCard);
            });
            
            // Add click listeners to DELETE buttons
            document.querySelectorAll('.delete-expense-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const expenseId = e.currentTarget.dataset.expenseId;
                    deleteExpense(expenseId);
                });
            });
        }

        // --- APP START ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
