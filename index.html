<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Sales & Expense Record</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom styles for printing */
        @media print {
            /* Hide the main form, header, and controls during print */
            #main-app, #header, #expense-section, #summary-section {
                display: none !important;
            }
            /* Show only the receipt content */
            #receipt-print-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 10px;
                background: white;
                
                /* Receipt-specific styling for light ink */
                font-family: 'Arial Black', sans-serif; /* Use a thick, bold font */
                color: #000; /* Ensure text is pure black */
                font-size: 10pt; /* Slightly larger default font size for clarity */
            }
            /* Reset body padding for print */
            body {
                padding: 0;
                margin: 0;
                background-color: white;
            }
            /* Ensure all text is bold and dark for light ink printers */
            #receipt-print-area * {
                font-weight: 700 !important; /* Make everything bold */
                color: #000 !important;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Print Area (Initially Hidden) -->
    <div id="receipt-print-area" class="hidden"></div>

    <!-- Main Application Container -->
    <div id="main-app" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-4 sm:p-8">
        <header id="header" class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-center text-indigo-700">Shop Sales & Expense Record (Local)</h1>
            <p class="text-center text-sm text-gray-500 mt-2" id="user-info">Data saved locally in your browser.</p> 
        </header>

        <main id="app-content">

            <!-- 0. Summary Section (Mahaana Jaiza) -->
            <section id="summary-section" class="mb-10 p-6 bg-gray-100 rounded-lg shadow-inner">
                <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Monthly Summary (Current Month)</h2>
                <div class="grid grid-cols-3 gap-4 text-center">
                    
                    <div class="bg-white p-4 rounded-lg shadow-md border-b-4 border-green-500">
                        <div class="text-sm font-medium text-gray-500">Total Sales</div>
                        <div id="total-sales" class="text-2xl font-extrabold text-green-700 mt-1">0.00 PKR</div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow-md border-b-4 border-red-500">
                        <div class="text-sm font-medium text-gray-500">Total Expenses</div>
                        <div id="total-expenses" class="text-2xl font-extrabold text-red-700 mt-1">0.00 PKR</div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow-md border-b-4 border-indigo-500">
                        <div class="text-sm font-medium text-gray-500">Net Profit</div>
                        <div id="net-profit" class="text-2xl font-extrabold text-indigo-700 mt-1">0.00 PKR</div>
                    </div>
                </div>
            </section>

            <!-- 1. New Sale Entry Form (Nayi Sale Entry) -->
            <section class="mb-10 p-6 bg-indigo-50 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-indigo-800 border-b pb-2">New Sale Entry</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <!-- Service Type Selector (Column 1) -->
                    <div>
                        <label for="service-type" class="block text-sm font-medium text-gray-700">Service / Item Category</label>
                        <select id="service-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- Services -->
                            <optgroup label="Photocopy">
                                <option value="Photocopy B/W">B/W (Single Sided)</option>
                                <option value="Photocopy (Double Sided B/W)">B/W (Double Sided)</option>
                                <option value="Photocopy Color">Color (Single Sided)</option>
                                <option value="Photocopy (Double Sided Color)">Color (Double Sided)</option>
                            </optgroup>
                            <optgroup label="Printing">
                                <option value="Print (B/W)">B/W (Single Sided)</option>
                                <option value="Print (Double Sided B/W)">B/W (Double Sided)</option>
                                <option value="Print (Color)">Color (Single Sided)</option>
                                <option value="Print (Double Sided Color)">Color (Double Sided)</option>
                            </optgroup>
                            <optgroup label="Other Services">
                                <option value="Scanning">Scanning</option>
                                <option value="Binding">Binding</option>
                            </optgroup>
                            <!-- Single option for all other stationery/custom items -->
                            <option value="Custom Stationery/Item">Stationery / Other Item (Manual Entry)</option>
                        </select>
                    </div>

                    <!-- Quantity Input (Column 2) -->
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="quantity" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Price Input (Can be adjusted manually) (Column 3) -->
                    <div>
                        <label for="price-per-unit" class="block text-sm font-medium text-gray-700">Price (Per Unit) PKR</label>
                        <input type="number" id="price-per-unit" step="0.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <!-- Add Button (Column 4) -->
                    <div class="flex items-end">
                        <button id="add-item-btn" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition duration-150 shadow-md">
                            Add Item
                        </button>
                    </div>
                </div>
                
                <!-- New Custom Description Input (Appears only when Stationery/Custom is selected) -->
                <div id="custom-item-name-container" class="mb-4" style="display: none;">
                    <label for="custom-item-name" class="block text-sm font-medium text-gray-700">Custom Item Name (Zaroori)</label>
                    <input type="text" id="custom-item-name" placeholder="e.g., A4 White Paper, Stapler, etc." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                </div>


                <!-- Current Sale Items -->
                <div id="current-sale-items" class="mt-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-2">Current Bill</h3>
                    <ul id="cart-list" class="space-y-2">
                        <!-- Items will be appended here -->
                        <li id="empty-cart-message" class="text-sm text-gray-500">No items added to the bill.</li>
                    </ul>
                </div>

                <!-- Total and Save Button -->
                <div class="mt-6 pt-4 border-t border-indigo-200 flex justify-between items-center">
                    <div class="text-xl font-bold text-indigo-900">
                        Total Amount: <span id="total-amount">0.00</span> PKR
                    </div>
                    <button id="save-sale-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg disabled:opacity-50" disabled>
                        Save Sale
                    </button>
                </div>
            </section>

            <!-- 2. Expense Entry Form (Naya Kharcha) -->
            <section id="expense-section" class="mb-10 p-6 bg-red-50 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-red-800 border-b pb-2">New Expense Entry</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <!-- Expense Description -->
                    <div class="col-span-1 md:col-span-2">
                        <label for="expense-description" class="block text-sm font-medium text-gray-700">Description / Item</label>
                        <input type="text" id="expense-description" placeholder="e.g., Paper stock purchase" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500">
                    </div>

                    <!-- Expense Amount -->
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-gray-700">Amount (PKR)</label>
                        <input type="number" id="expense-amount" min="1" step="0.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-red-500 focus:border-red-500">
                    </div>

                    <!-- Save Expense Button -->
                    <div class="flex items-end">
                        <button id="save-expense-btn" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition duration-150 shadow-md">
                            Save Expense
                        </button>
                    </div>
                </div>
            </section>

            <!-- 3. Recent Sales Record (Haaliya Sales Record) -->
            <section class="p-6 bg-white rounded-lg shadow-md mb-10">
                <h2 class="text-xl font-semibold mb-4 text-indigo-800 border-b pb-2">Recent Sales History</h2>
                <div id="sales-list" class="space-y-4">
                    <!-- Sales records will be displayed here -->
                    <p id="no-sales-message" class="text-gray-500">No sales record found.</p>
                </div>
            </section>
            
            <!-- 4. Recent Expenses Record (Haaliya Kharchay) -->
            <section class="p-6 bg-white rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4 text-red-800 border-b pb-2">Recent Expenses History</h2>
                <div id="expenses-list" class="space-y-4">
                    <!-- Expense records will be displayed here -->
                    <p id="no-expenses-message" class="text-gray-500">No expense record found.</p>
                </div>
            </section>

            <!-- Custom Message Box for errors/success -->
            <div id="message-box" class="fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-xl transition-opacity duration-300 hidden" style="opacity: 0;">
                <!-- Message content here -->
            </div>

        </main>
    </div>

    <!-- Local Storage Script -->
    <script type="module">
        
        // --- DOM Elements ---
        // Sales elements
        const serviceTypeSelect = document.getElementById('service-type');
        const quantityInput = document.getElementById('quantity');
        const pricePerUnitInput = document.getElementById('price-per-unit');
        const addItemBtn = document.getElementById('add-item-btn');
        const cartList = document.getElementById('cart-list');
        const totalAmountSpan = document.getElementById('total-amount');
        const saveSaleBtn = document.getElementById('save-sale-btn');
        const salesListContainer = document.getElementById('sales-list');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const noSalesMessage = document.getElementById('no-sales-message');
        const receiptPrintArea = document.getElementById('receipt-print-area');
        const messageBox = document.getElementById('message-box');
        
        // New custom stationery elements
        const customItemNameContainer = document.getElementById('custom-item-name-container');
        const customItemNameInput = document.getElementById('custom-item-name');


        // Expense elements
        const expenseDescriptionInput = document.getElementById('expense-description');
        const expenseAmountInput = document.getElementById('expense-amount');
        const saveExpenseBtn = document.getElementById('save-expense-btn');
        const expensesListContainer = document.getElementById('expenses-list');
        const noExpensesMessage = document.getElementById('no-expenses-message');
        
        // Summary elements
        const totalSalesSpan = document.getElementById('total-sales');
        const totalExpensesSpan = document.getElementById('total-expenses');
        const netProfitSpan = document.getElementById('net-profit');

        // --- CONSTANTS AND STATE ---
        let currentCart = []; // {type, quantity, unitPrice, subTotal}
        const LOCAL_STORAGE_SALE_KEY = 'shop_sales_data'; // Key for sales data
        const LOCAL_STORAGE_EXPENSE_KEY = 'shop_expenses_data'; // Key for expense data
        
        // Company details for receipt
        const COMPANY_NAME = "Zaman Printing Services";
        const COMPANY_ADDRESS = "Basement No. 6, Al-Anayat Shopping Mall, G-11 Markaz, Islamabad";


        // Service rates (Updated with new Print and Double Sided options)
        const PRICE_LIST = {
            // Photocopy
            'Photocopy B/W': 7.0, 
            'Photocopy (Double Sided B/W)': 14.0, // 7.0 * 2
            'Photocopy Color': 40.0,
            'Photocopy (Double Sided Color)': 80.0, // 40.0 * 2
            
            // Printing (Default price 10 and 40 as requested)
            'Print (B/W)': 10.0, // Requested 10
            'Print (Double Sided B/W)': 20.0, // 10.0 * 2
            'Print (Color)': 40.0, // Requested 40
            'Print (Double Sided Color)': 80.0, // 40.0 * 2
            
            // Other Services
            'Scanning': 20.0,
            'Binding': 70.0,
        };

        // --- UTILITY FUNCTIONS ---

        /** Shows a temporary message notification */
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = 'fixed top-4 right-4 text-white p-4 rounded-lg shadow-xl transition-opacity duration-300';
            messageBox.style.opacity = 1;
            messageBox.classList.add(isError ? 'bg-red-500' : 'bg-green-600');
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.style.opacity = 0;
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        /** Formats a timestamp into a readable date/time string. */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            const options = {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit',
                hour12: true
            };
            return date.toLocaleString('en-US', options);
        }
        
        /** Checks if a date falls within the current month (for summary) */
        function isCurrentMonth(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            return date.getFullYear() === now.getFullYear() && date.getMonth() === now.getMonth();
        }
        
        // --- LOCAL STORAGE FUNCTIONS: SALES ---

        /** Loads sales data from local storage, or returns an empty array. */
        function loadSalesFromLocalStorage() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_SALE_KEY);
                const sales = data ? JSON.parse(data) : [];
                
                sales.forEach(sale => {
                    if (typeof sale.items === 'string') {
                        try {
                            sale.items = JSON.parse(sale.items);
                        } catch (e) {
                            console.error("Failed to parse items array from local storage:", e);
                            sale.items = [];
                        }
                    }
                });

                // Sort the sales locally by date (newest first)
                sales.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                
                return sales;
            } catch (error) {
                console.error("Error loading sales data from local storage:", error);
                return [];
            }
        }

        /** Saves the current array of sales back to local storage. */
        function saveSalesToLocalStorage(sales) {
            try {
                localStorage.setItem(LOCAL_STORAGE_SALE_KEY, JSON.stringify(sales));
                renderSalesList(sales); // Re-render the list after saving
                updateSummary();
            } catch (error) {
                console.error("Error saving sales data to local storage:", error);
                showMessage('Error saving sale data locally.', true);
            }
        }
        
        /** Deletes a sale record by ID. */
        function deleteSale(saleId) {
            const saleIdInt = parseInt(saleId, 10);
            const existingSales = loadSalesFromLocalStorage();
            const updatedSales = existingSales.filter(sale => sale.id !== saleIdInt);

            saveSalesToLocalStorage(updatedSales);
            showMessage('Sale record deleted successfully. (Permanent Action)', false);
        }


        // --- LOCAL STORAGE FUNCTIONS: EXPENSES ---

        /** Loads expenses data from local storage, or returns an empty array. */
        function loadExpensesFromLocalStorage() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_EXPENSE_KEY);
                const expenses = data ? JSON.parse(data) : [];
                
                // Sort the expenses locally by date (newest first)
                expenses.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
                
                return expenses;
            } catch (error) {
                console.error("Error loading expenses data from local storage:", error);
                return [];
            }
        }

        /** Saves the current array of expenses back to local storage. */
        function saveExpensesToLocalStorage(expenses) {
            try {
                localStorage.setItem(LOCAL_STORAGE_EXPENSE_KEY, JSON.stringify(expenses));
                renderExpenseList(expenses); // Re-render the list after saving
                updateSummary();
            } catch (error) {
                console.error("Error saving expenses data to local storage:", error);
                showMessage('Error saving expense data locally.', true);
            }
        }
        
        /** Deletes an expense record by ID. */
        function deleteExpense(expenseId) {
            const expenseIdInt = parseInt(expenseId, 10);
            const existingExpenses = loadExpensesFromLocalStorage();
            const updatedExpenses = existingExpenses.filter(expense => expense.id !== expenseIdInt);

            saveExpensesToLocalStorage(updatedExpenses);
            showMessage('Expense record deleted successfully. (Permanent Action)', false);
        }
        
        // --- SUMMARY FUNCTION ---
        
        /** Calculates and updates the monthly summary stats. */
        function updateSummary() {
            const allSales = loadSalesFromLocalStorage();
            const allExpenses = loadExpensesFromLocalStorage();
            const currentMonthSales = allSales.filter(sale => isCurrentMonth(sale.date));
            const currentMonthExpenses = allExpenses.filter(expense => isCurrentMonth(expense.date));
            
            const totalSales = currentMonthSales.reduce((sum, sale) => sum + sale.totalAmount, 0);
            const totalExpenses = currentMonthExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = totalSales - totalExpenses;
            
            totalSalesSpan.textContent = totalSales.toFixed(2) + ' PKR';
            totalExpensesSpan.textContent = totalExpenses.toFixed(2) + ' PKR';
            netProfitSpan.textContent = netProfit.toFixed(2) + ' PKR';
            
            if (netProfit < 0) {
                netProfitSpan.classList.remove('text-indigo-700');
                netProfitSpan.classList.add('text-red-700');
            } else {
                netProfitSpan.classList.add('text-indigo-700');
                netProfitSpan.classList.remove('text-red-700');
            }
        }


        // --- RENDERING FUNCTIONS ---

        /** Calculates and updates the cart's total amount */
        function updateCartTotal() {
            const total = currentCart.reduce((sum, item) => sum + item.subTotal, 0);
            totalAmountSpan.textContent = total.toFixed(2);
            saveSaleBtn.disabled = currentCart.length === 0;
            emptyCartMessage.style.display = currentCart.length === 0 ? 'block' : 'none';
        }

        /** Renders the current items in the cart UI */
        function renderCart() {
            cartList.innerHTML = '';
            currentCart.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-white border border-gray-200 rounded-md';
                li.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-medium">${item.type}</span> 
                        <span class="text-sm text-gray-500">(${item.quantity} x ${item.unitPrice.toFixed(2)} PKR)</span>
                    </div>
                    <div class="font-bold text-indigo-600">${item.subTotal.toFixed(2)} PKR</div>
                    <button data-index="${index}" class="remove-item-btn ml-4 text-red-500 hover:text-red-700 transition duration-150" title="Remove Item">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                cartList.appendChild(li);
            });
            updateCartTotal();
            
            document.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index, 10);
                    currentCart.splice(index, 1);
                    renderCart();
                    showMessage('Item removed.');
                });
            });
        }
        
        /** Renders the list of all saved sales */
        function renderSalesList(sales) {
            salesListContainer.innerHTML = '';
            
            if (sales.length === 0) {
                noSalesMessage.style.display = 'block';
                return;
            }
            noSalesMessage.style.display = 'none';

            sales.forEach(sale => {
                const saleCard = document.createElement('div');
                saleCard.className = 'p-4 border border-gray-200 rounded-lg shadow-sm bg-white hover:shadow-md transition duration-150';
                
                const dateStr = formatTimestamp(sale.date);
                
                const itemsArray = Array.isArray(sale.items) ? sale.items : [];
                const itemsSummary = itemsArray.map(item => `${item.type} (${item.quantity})`).join(', ');

                saleCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-lg font-bold text-indigo-700">${sale.totalAmount.toFixed(2)} PKR</div>
                        <span class="text-sm text-gray-500">${dateStr}</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-3 truncate" title="${itemsSummary}">Items: ${itemsSummary}</p>
                    
                    <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                        <!-- Print Button -->
                        <button data-sale-id="${sale.id}" class="print-btn text-blue-600 hover:text-blue-800 font-medium transition duration-150 flex items-center text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 4v2a2 2 0 002 2h6a2 2 0 002-2V4h1a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2h1zm0 2h10v10a1 1 0 01-1 1H6a1 1 0 01-1-1V6z" clip-rule="evenodd" />
                                <path d="M10 12a1 1 0 100-2 1 1 0 000 2z" />
                            </svg>
                            Print Receipt
                        </button>
                        
                        <!-- Delete Button -->
                        <button data-sale-id="${sale.id}" class="delete-sale-btn text-red-500 hover:text-red-700 font-medium transition duration-150 flex items-center text-sm">
                            <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete
                        </button>
                    </div>
                `;
                salesListContainer.appendChild(saleCard);
            });
            
            // Add click listeners to print buttons
            document.querySelectorAll('.print-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const saleId = e.currentTarget.dataset.saleId;
                    const sales = loadSalesFromLocalStorage();
                    const saleToPrint = sales.find(s => String(s.id) === saleId);
                    
                    if (saleToPrint) {
                        printReceipt(saleToPrint);
                    } else {
                        showMessage('Sale record not found.', true);
                    }
                });
            });
            
            // Add click listeners to DELETE buttons
            document.querySelectorAll('.delete-sale-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const saleId = e.currentTarget.dataset.saleId;
                    deleteSale(saleId);
                });
            });
        }
        
        /** Renders the list of all saved expenses */
        function renderExpenseList(expenses) {
            expensesListContainer.innerHTML = '';
            
            if (expenses.length === 0) {
                noExpensesMessage.style.display = 'block';
                return;
            }
            noExpensesMessage.style.display = 'none';

            expenses.forEach(expense => {
                const expenseCard = document.createElement('div');
                expenseCard.className = 'p-4 border border-gray-200 rounded-lg shadow-sm bg-white hover:shadow-md transition duration-150 flex justify-between items-center';
                
                const dateStr = formatTimestamp(expense.date);

                expenseCard.innerHTML = `
                    <div class="flex-grow">
                        <div class="text-md font-medium text-gray-800">${expense.description}</div>
                        <span class="text-sm text-gray-500">${dateStr}</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="text-lg font-bold text-red-700">${expense.amount.toFixed(2)} PKR</div>
                        
                        <!-- Delete Button -->
                        <button data-expense-id="${expense.id}" class="delete-expense-btn text-gray-400 hover:text-red-600 transition duration-150 p-1 rounded" title="Delete Expense">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                expensesListContainer.appendChild(expenseCard);
            });
            
            // Add click listeners to DELETE buttons
            document.querySelectorAll('.delete-expense-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const expenseId = e.currentTarget.dataset.expenseId;
                    deleteExpense(expenseId);
                });
            });
        }
        
        /** Generates and triggers the print functionality for a saved sale */
        function printReceipt(sale) {
            const dateStr = formatTimestamp(sale.date);
            
            let itemsHtml = sale.items.map(item => `
                <tr>
                    <td class="py-1 px-2 border-r border-black">${item.type}</td>
                    <td class="py-1 px-2 border-r border-black text-center">${item.quantity}</td>
                    <td class="py-1 px-2 border-r border-black text-right">${item.unitPrice.toFixed(2)}</td>
                    <td class="py-1 px-2 text-right">${item.subTotal.toFixed(2)}</td>
                </tr>
            `).join('');

            // Updated receipt format with Company Name and Address
            const receiptHtml = `
                <div class="max-w-xs mx-auto p-4 border border-black text-xs">
                    <div class="text-center mb-3">
                        <h2 class="font-extrabold text-base mb-1">${COMPANY_NAME}</h2>
                        <p class="text-xs italic">${COMPANY_ADDRESS}</p>
                    </div>
                    
                    <p class="mb-1"><strong>Date:</strong> ${dateStr}</p>
                    <p class="mb-3"><strong>Transaction ID:</strong> ${sale.id}</p>
                    
                    <table class="w-full border-collapse mb-3 border border-black">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-1 px-2 border-r border-b border-black text-left">Item</th>
                                <th class="py-1 px-2 border-r border-b border-black text-center">Qty</th>
                                <th class="py-1 px-2 border-r border-b border-black text-right">Rate</th>
                                <th class="py-1 px-2 border-b border-black text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>

                    <div class="flex justify-between font-bold text-sm border-t border-black pt-2">
                        <span>Total Amount</span>
                        <span>${sale.totalAmount.toFixed(2)} PKR</span>
                    </div>
                    
                    <p class="text-center mt-4 border-t border-black pt-2">Thank you for your business!</p>
                </div>
            `;
            
            receiptPrintArea.innerHTML = receiptHtml;
            window.print();
        }

        // --- GENERAL APP FLOW FUNCTIONS ---

        /** Resets the sale form and cart */
        function resetSale() {
            currentCart = [];
            renderCart();
            quantityInput.value = 1;
            // Set default to the first standard service (Photocopy B/W single-sided)
            serviceTypeSelect.value = 'Photocopy B/W'; 
            updatePricePerUnit();
            customItemNameInput.value = ''; // Reset custom item name
        }
        
        /** Resets the expense form */
        function resetExpenseForm() {
            expenseDescriptionInput.value = '';
            expenseAmountInput.value = '';
        }
        
        /** Initial load and display of the app */
        function initializeApp() {
            // Load and render sales and expenses
            const sales = loadSalesFromLocalStorage();
            renderSalesList(sales);
            
            const expenses = loadExpensesFromLocalStorage();
            renderExpenseList(expenses);

            updatePricePerUnit();
            updateSummary();
        }

        // --- EVENT HANDLERS: SALE ---

        /** Updates the Price Per Unit input with the default rate for the selected service, and toggles custom input visibility. */
        function updatePricePerUnit() {
            const selectedType = serviceTypeSelect.value;
            
            if (selectedType === 'Custom Stationery/Item') {
                // If Custom is selected, show the manual description input
                customItemNameContainer.style.display = 'block';
                // Reset price to 0, forcing manual entry by the user
                pricePerUnitInput.value = '0.00'; 
            } else {
                // If a fixed service is selected, hide the manual description input
                customItemNameContainer.style.display = 'none';
                
                // Set default price from list
                const price = PRICE_LIST[selectedType] || 0;
                pricePerUnitInput.value = price.toFixed(2);
            }
        }
        
        serviceTypeSelect.addEventListener('change', updatePricePerUnit);

        addItemBtn.addEventListener('click', () => {
            let type = serviceTypeSelect.value;
            const quantity = parseInt(quantityInput.value, 10);
            const unitPrice = parseFloat(pricePerUnitInput.value); 

            if (quantity < 1 || isNaN(quantity) || unitPrice <= 0 || isNaN(unitPrice)) {
                showMessage('Please enter valid quantity and price.', true);
                return;
            }
            
            // If custom option is selected, validate and use the custom name
            if (type === 'Custom Stationery/Item') {
                const customName = customItemNameInput.value.trim();
                if (!customName) {
                    showMessage('Please enter the name of the custom item (Zaroori).', true);
                    return;
                }
                type = customName; // Use the custom name as the item type
            }


            const subTotal = quantity * unitPrice;
            
            currentCart.push({ type, quantity, unitPrice, subTotal });
            
            renderCart();
            quantityInput.value = 1; 
            customItemNameInput.value = ''; // Clear custom input after adding
            showMessage(`${type} added to the bill.`);
            
            // If it was a custom item, switch back to the first non-custom option or reset
            if (serviceTypeSelect.value === 'Custom Stationery/Item') {
                serviceTypeSelect.value = 'Photocopy B/W'; // Reset to a fixed option
                updatePricePerUnit();
            }
        });

        saveSaleBtn.addEventListener('click', () => {
            if (currentCart.length === 0) {
                showMessage('Please add items to the bill first.', true);
                return;
            }

            saveSaleBtn.disabled = true;
            saveSaleBtn.textContent = 'Saving...';
            
            const totalAmount = currentCart.reduce((sum, item) => sum + item.subTotal, 0);
            
            const newSale = {
                id: Date.now(), 
                date: new Date().toISOString(), 
                items: currentCart, 
                totalAmount: totalAmount,
            };

            const existingSales = loadSalesFromLocalStorage();
            existingSales.push(newSale);
            saveSalesToLocalStorage(existingSales);

            showMessage('Sale saved successfully to your browser!', false);
            resetSale();
            
            saveSaleBtn.disabled = false;
            saveSaleBtn.textContent = 'Save Sale';
        });
        
        // --- EVENT HANDLERS: EXPENSE ---
        
        saveExpenseBtn.addEventListener('click', () => {
            const description = expenseDescriptionInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);

            if (!description) {
                showMessage('Please enter a description for the expense.', true);
                return;
            }
            if (amount <= 0 || isNaN(amount)) {
                showMessage('Please enter a valid expense amount.', true);
                return;
            }

            saveExpenseBtn.disabled = true;
            saveExpenseBtn.textContent = 'Saving...';

            const newExpense = {
                id: Date.now(),
                date: new Date().toISOString(),
                description: description,
                amount: amount,
            };

            const existingExpenses = loadExpensesFromLocalStorage();
            existingExpenses.push(newExpense);
            saveExpensesToLocalStorage(existingExpenses);
            
            showMessage('Expense saved successfully!', false);
            resetExpenseForm();
            
            saveExpenseBtn.disabled = false;
            saveExpenseBtn.textContent = 'Save Expense';
        });

        // --- APP START ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
